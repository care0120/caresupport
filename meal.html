<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>🍙 食事の記録</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <base target="_top"> <style>
    body {
      font-family: sans-serif;
      font-size: 26px; /* medicine.htmlに合わせる */
      padding: 1.5em 0.5em 1.5em 0.5em; /* medicine.htmlに合わせる */
      background: #fff;
      color: #000; /* デフォルトの文字色 */
      text-align: left;
      line-height: 1.5; /* 行間の調整 */
    }
    h1 {
      font-size: 32px; /* medicine.htmlに合わせる */
      margin: 0.2em 0 0.4em; /* medicine.htmlに合わせる */
    }
    .section {
      margin-bottom: 1.5em; /* medicine.htmlに合わせる */
    }
    /* チェックボックス/ラジオボタンのグリッドレイアウトを調整 */
    .checkbox-grid, .radio-group {
      display: grid;
      /* 最小幅を少し広げて連結を防ぎ、画面幅に応じて列数を調整 */
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); 
      gap: 1.2em; /* ボタン間の隙間を少し増やす */
    }
    /* チェックボックス/ラジオボタンのラベル共通スタイル */
    .checkbox-grid label,
    .radio-group label {
      display: flex; 
      align-items: center;
      justify-content: center; /* 水平方向中央 */
      text-align: center; /* テキストも中央揃え */
      border: 2px solid #888;
      border-radius: 10px;
      padding: 0.8em 0.5em; /* パディングを左右で少し詰める */
      background: #f0f0f0;
      cursor: pointer;
      font-size: 26px; 
      box-sizing: border-box; 
      white-space: nowrap; /* テキストがボタン内で改行されないように */
      transition: background-color 0.2s, border-color 0.2s, color 0.2s; 
      min-width: 100px; /* 各ボタンの最小幅を確保 */
      height: 2.5em; /* 高さを揃える */
    }
    /* 選択された際のスタイル */
    .checkbox-grid input[type="checkbox"]:checked + label,
    .radio-group input[type="radio"]:checked + label {
      background: #007BFF;
      color: white;
      border-color: #0056b3;
    }

    /* テキストエリアとテキスト入力欄のスタイル */
    textarea, input[type="text"] {
      width: 100%;
      font-size: 24px; 
      padding: 0.8em; 
      box-sizing: border-box;
      border: 1px solid #ccc;
      border-radius: 5px;
    }
    textarea {
      height: 6em; 
      resize: vertical; 
    }
    input[type="text"][name="side"] { 
      height: auto; 
      min-height: 2.5em; 
    }

    /* おかず、感想のラベルを主食と同じサイズと太字に */
    .section strong,
    .section > label { /* 直接のlabel要素に適用 */
        font-size: 26px; /* 主食と同じサイズ */
        font-weight: bold; /* 太字 */
        display: block; /* ブロック要素にして独立させる */
        margin-bottom: 0.5em; /* 下に少し余白 */
    }

    /* ボタンのスタイル (medicine.htmlを参考に拡大) */
    .send-btn, .back-btn {
      display: block; 
      font-size: 28px; 
      border-radius: 10px; 
      padding: 1.2em 2em; 
      cursor: pointer;
      box-sizing: border-box;
      white-space: nowrap; 
      text-align: center; 
      width: 100%; 
      max-width: 700px; 
      transition: background-color 0.2s, border-color 0.2s, color 0.2s; 
    }
    .send-btn {
      background-color: #add8e6; 
      color: #000; 
      border: 3px solid #007BFF; 
    }
    .send-btn:hover {
        background-color: #9ac0d6; 
    }
    .back-btn {
      background-color: #eeeeee; 
      color: #333; 
      border: 2px solid #999; 
    }
    .back-btn:hover {
        background-color: #dddddd; 
    }
    /* ボタンを縦に並べ、中央に配置するコンテナ */
    .button-row {
      display: flex;
      flex-direction: column; 
      gap: 1.2em; 
      align-items: center; 
      margin-top: 2em; 
      width: 100%; 
    }

    /* 「履歴」リンクのスタイルを修正 */
    #historyLink {
      position: fixed;
      bottom: 0.8rem; 
      right: 0.8rem; 
      font-size: 1.2rem; 
      opacity: 0.9; 
      color: #007BFF; 
      text-decoration: underline; 
      z-index: 9000; 
    }
    /* 「おかず」と「感想」の例テキストのスタイル */
    .sub {
      font-size: 26px; /* 感想やおかずの例のフォントサイズを、主食のラベルと同じにする */
      color: #555;
      margin-bottom: 0.3em;
      margin-top: 0.3em; 
    }

    /* ポップアップのスタイル修正 */
    #successPopup, #errorPopup {
        position:fixed; 
        top: 45%; 
        left:50%; 
        transform:translate(-50%, -50%);
        background: white; 
        border: 4px solid #007BFF; 
        border-radius: 16px; 
        padding: 1.5em 1em; /* パディングを左右で少し減らす */
        z-index: 9999;
        font-size: 2.2rem; /* フォントサイズを調整 */
        text-align: center; 
        box-shadow: 0 0 10px rgba(0,0,0,0.3);
        max-width: 90vw; /* 画面幅の90%に制限 */
        word-break: keep-all; /* 単語の途中での改行を防ぐ */
    }
    #errorPopup {
        border: 2px solid red;
        color: red;
        background: #fff8f8;
    }
    /* 送信完了メッセージを赤字にする */
    #successPopup {
        color: red; 
    }
  </style>
</head>
<body>
  <h1>🍙 食事の記録</h1>
  <form id="mealForm">
    <div class="section">
      <strong>主食を選択</strong> 
      <div class="checkbox-grid">
        <label><input type="checkbox" name="main" value="ごはん" />ごはん</label>
        <label><input type="checkbox" name="main" value="パン" />パン</label>
        <label><input type="checkbox" name="main" value="めん" />めん</label>
        <label><input type="checkbox" name="main" value="魚" />魚</label>
        <label><input type="checkbox" name="main" value="肉" />肉</label>
        <label><input type="checkbox" name="main" value="野菜" />野菜</label>
        <label><input type="checkbox" name="main" value="弁当" />弁当</label>
      </div>
    </div>

    <div class="section">
      <label>🍱 おかず</label> 
      <div class="sub">（例：チキン、サラダなど）</div> 
      <textarea name="side" rows="1"></textarea>
    </div>

    <div class="section">
      <strong>量</strong> 
      <div class="radio-group">
        <label><input type="radio" name="amount" value="多め" />多め</label>
        <label><input type="radio" name="amount" value="ふつう" />ふつう</label>
        <label><input type="radio" name="amount" value="少なめ" />少なめ</label>
      </div>
    </div>

    <div class="section">
      <label>🍀 感想・気になること</label> 
      <div class="sub">（🎙️マイクでも書けます）</div> 
      <textarea name="comment" rows="4"></textarea> 
    </div>

    <div class="button-row">
      <button type="button" class="send-btn" onclick="submitForm()">👆 報告する</button>
      <button type="button" class="back-btn" onclick="history.back()">← 戻る</button>
    </div>
  </form>

  <a id="historyLink" href="history.html">履歴</a> 

  <div id="successPopup" style="display:none;">⭕ 送信完了</div>
  <div id="errorPopup" style="display:none;">❌ 入力してください</div>

  <script>
    // ★ここにGASウェブアプリのURLを貼り付ける★
    const GAS_WEB_APP_URL = "https://script.google.com/macros/s/AKfycbw5LUmzbYy9ja_39IBnD13088qnKtHFgRFfL-0ApPy21rHaxdS8hL83WsRiqY0yBWY/exec"; 

    async function submitForm() {
      const f = document.forms.mealForm;

      const main = [...f.main].filter(c => c.checked).map(c => c.value).join(',');
      const side = f.side.value.trim();
      const amount = f.amount.value || ""; 
      const comment = f.comment.value.trim();

      // 入力チェック
      if (!main && !side && !amount && !comment) {
        document.getElementById("errorPopup").textContent = "❌ いずれか1つは入力してください";
        document.getElementById("errorPopup").style.display = "block";
        setTimeout(() => {
          document.getElementById("errorPopup").style.display = "none";
          document.getElementById("errorPopup").textContent = "❌ 入力してください";
        }, 2000);
        return; 
      }

      // データオブジェクトを作成
      const data = {
        type: "meal", // GASのdoPostで処理されるタイプ
        values: [main, side, amount, comment]
      };

      try {
        const response = await fetch(GAS_WEB_APP_URL, {
          method: 'POST',
          mode: 'cors', // CORSモードを明示的に指定
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(data) // JSON形式で送信
        });

        if (!response.ok) {
          // HTTPステータスが200番台以外の場合
          const errorText = await response.text(); // エラーレスポンスの本文を取得
          throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
        }

        const result = await response.json(); // レスポンスをJSONとしてパース

        if (result.status === 'ok') {
          document.getElementById("successPopup").style.display = "block";
          setTimeout(() => {
            document.getElementById("successPopup").style.display = "none";
            // フォームのリセット
            [...f.main].forEach(c => c.checked = false); 
            f.side.value = ""; 
            [...f.amount].forEach(r => r.checked = false); 
            f.comment.value = ""; 
          }, 2000); 
        } else {
          // GASから返されたカスタムエラーメッセージがあれば表示
          throw new Error(result.message || "不明なエラー");
        }
      } catch (e) {
          console.error('送信エラー:', e);
          document.getElementById("errorPopup").textContent = "❌ 送信に失敗しました: " + e.message;
          document.getElementById("errorPopup").style.display = "block";
          setTimeout(() => {
            document.getElementById("errorPopup").style.display = "none";
            document.getElementById("errorPopup").textContent = "❌ 入力してください"; 
          }, 4000); 
      }
    }
  </script>
</body>
</html>
