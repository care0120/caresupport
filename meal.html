<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>🍙 食事の記録</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <base target="_top"> <style>
    /* （スタイルシートのコードは変更なし） */
    /* ... 既存のスタイルコード ... */
  </style>
  
  <script>
    // ★ここにGASウェブアプリのURLを貼り付ける★
    const GAS_WEB_APP_URL = "https://script.google.com/macros/s/AKfycbybsv4CXX2SRxjKOvv9wljwj31FVtMjeaexb2MoWzbl4Tjqvk69RsRXGSmZBFxH1L2i/exec"; 

    async function submitForm() {
      const f = document.forms.mealForm;

      const main = [...f.main].filter(c => c.checked).map(c => c.value).join(',');
      const side = f.side.value.trim();
      const amount = f.amount.value || ""; 
      const comment = f.comment.value.trim();

      // 入力チェック
      if (!main && !side && !amount && !comment) {
        document.getElementById("errorPopup").textContent = "❌ いずれか1つは入力してください";
        document.getElementById("errorPopup").style.display = "block";
        setTimeout(() => {
          document.getElementById("errorPopup").style.display = "none";
          document.getElementById("errorPopup").textContent = "❌ 入力してください";
        }, 2000);
        return; 
      }

      // データオブジェクトを作成
      const data = {
        type: "meal", // GASのdoPostで処理されるタイプ
        values: [main, side, amount, comment]
      };

      try {
        const response = await fetch(GAS_WEB_APP_URL, {
          method: 'POST',
          mode: 'cors', // CORSモードを明示的に指定
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(data) // JSON形式で送信
        });

        if (!response.ok) {
          // HTTPステータスが200番台以外の場合
          const errorText = await response.text(); // エラーレスポンスの本文を取得
          throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
        }

        const result = await response.json(); // レスポンスをJSONとしてパース

        if (result.status === 'ok') {
          document.getElementById("successPopup").style.display = "block";
          setTimeout(() => {
            document.getElementById("successPopup").style.display = "none";
            // フォームのリセット
            [...f.main].forEach(c => c.checked = false); 
            f.side.value = ""; 
            [...f.amount].forEach(r => r.checked = false); 
            f.comment.value = ""; 
          }, 2000); 
        } else {
          // GASから返されたカスタムエラーメッセージがあれば表示
          throw new Error(result.message || "不明なエラー");
        }
      } catch (e) {
          console.error('送信エラー:', e);
          document.getElementById("errorPopup").textContent = "❌ 送信に失敗しました: " + e.message;
          document.getElementById("errorPopup").style.display = "block";
          setTimeout(() => {
            document.getElementById("errorPopup").style.display = "none";
            document.getElementById("errorPopup").textContent = "❌ 入力してください"; 
          }, 4000); 
      }
    }
  </script>
</head>
<body>
  <h1>🍙 食事の記録</h1>
  <form id="mealForm">
    <div class="button-row">
      <button type="button" class="send-btn" onclick="submitForm()">👆 報告する</button>
      <button type="button" class="back-btn" onclick="history.back()">← 戻る</button>
    </div>
  </form>

  <a id="historyLink" href="history.html">履歴</a> 

  <div id="successPopup" style="display:none;">⭕ 送信完了</div>
  <div id="errorPopup" style="display:none;">❌ 入力してください</div>

</body>
</html>
